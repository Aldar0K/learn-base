FROM node:20-slim

WORKDIR /usr/app

# Установка OpenSSL для Prisma и procps для NestJS watch mode
RUN apt-get update && \
    apt-get install -y openssl procps && \
    rm -rf /var/lib/apt/lists/*

# Копируем файлы зависимостей
COPY package.json yarn.lock ./

# Копируем prisma схему до установки зависимостей
COPY prisma ./prisma

# Устанавливаем все зависимости (включая dev для разработки)
RUN yarn install

# Копируем исходный код
COPY . .

# Генерируем Prisma Client для правильной платформы
RUN yarn prisma:generate

CMD ["yarn", "start:dev"]
